language: node_js
node_js:
  - "5.4.1"
services:
  - mysql
before_install:
  - mysql -e 'CREATE DATABASE `tutor-buddy`;'
  - mysql - e 'CREATE DEFINER=`root`@`%` PROCEDURE `deleteBatch-test`(IN batchId INT(11) ) BEGIN DECLARE eachBatchStudent INT; DECLARE studentIteratorDone INT DEFAULT FALSE; DECLARE cursor_studentsNotInOtherBatches CURSOR FOR SELECT a.student_id FROM (SELECT student_id FROM `batch_student_map-test` GROUP BY student_id HAVING (COUNT(DISTINCT batch_id) = 1)) AS a INNER JOIN (SELECT student_id FROM `batch_student_map-test` WHERE batch_id = batchId) AS b WHERE a.student_id = b.student_id; DECLARE CONTINUE HANDLER FOR NOT FOUND SET studentIteratorDone = TRUE; START TRANSACTION; OPEN cursor_studentsNotInOtherBatches; batchStudentsLoop: LOOP FETCH cursor_studentsNotInOtherBatches INTO eachBatchStudent; IF studentIteratorDone THEN LEAVE batchStudentsLoop; END IF; DELETE FROM `students-test` WHERE id = eachBatchStudent; END LOOP; DELETE FROM `batch_student_map-test` WHERE batch_id = batchId; DELETE FROM `tutor_batch_map-test` WHERE batch_id = batchId; DELETE FROM `batches-test` WHERE id = batchId; COMMIT; END'